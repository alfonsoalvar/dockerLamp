services:
  # Traefik Reverse Proxy
  traefik:
    image: traefik:v2.11.30
    container_name: traefik
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic_conf:/etc/traefik/dynamic_conf:ro
      - ./traefik/acme_data:/acme_data
    networks:
      - proxy
    labels:
      # ROUTER HTTPS (Acceso seguro)
      - "traefik.http.routers.dashboard.rule=Host(`traefik.local`)"
      - "traefik.http.routers.dashboard.entrypoints=websecure"
      - "traefik.http.routers.dashboard.tls.certresolver=stagingacme"
      - "traefik.http.routers.dashboard.service=api@internal" # <-- Servicio interno del Dashboard

  # Apache HTTP Server
  apache:
    build:
      context: ./apache
      dockerfile: Dockerfile_2.4
    container_name: apache
    restart: always
    volumes:
      # Montamos la configuraci贸n de vhosts
      - ./apache/vhosts:/etc/apache2/sites-enabled
      # Montamos las carpetas de los sitios
      - ./sites:/var/www/html
    networks:
      - proxy
      - default # Para comunicarse con FPM (ProxyPassMatch usa el nombre del servicio)

  # Contenedores de PHP-FPM (Globales)
  php74:
    build:
      context: ./php-fpm
      dockerfile: Dockerfile_7.4
    container_name: php74
    restart: always
    env_file:
      - .env
    volumes:
      - ./sites:/var/www/html
    networks:
      - default

  php84:
    build:
      context: ./php-fpm
      dockerfile: Dockerfile_8.4
    container_name: php84
    restart: always
    env_file:
      - .env
    volumes:
      - ./sites:/var/www/html
    networks:
      - default
      
  # MariaDB
  mariadb:
    image: mariadb:lts
    container_name: mariadb
    restart: always
    ports:
      - "3306:3306"
    env_file:
      - .env
    volumes:
      - ./mariadb/data:/var/lib/mysql
      - ./mariadb/initdb:/docker-entrypoint-initdb.d
    networks:
      - default

  # Adminer (Gestor de bases de datos)
  adminer:
    image: adminer:latest
    container_name: adminer
    restart: always
    networks:
      - default
      - proxy # Debe estar en la red de Traefik
    environment:
      ADMINER_DEFAULT_SERVER: mariadb
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Define el router web (puerto 80)
      #- "traefik.http.routers.adminer-http.rule=Host(`adminer.local`)"
      #- "traefik.http.routers.adminer-http.entrypoints=web" # Escucha en HTTP (80)
      #- "traefik.http.routers.adminer-http.middlewares=redirect-to-https@file" # Redirecciona a HTTPS
      # Define el router websecure (puerto 443)
      - "traefik.http.routers.adminer.rule=Host(`adminer.local`)"
      - "traefik.http.routers.adminer.entrypoints=websecure" # Escucha en HTTPS (443)
      # Habilita TLS usando el resolvedor de certificados stagingacme
      - "traefik.http.routers.adminer.tls=true"
      - "traefik.http.routers.adminer.tls.certresolver=stagingacme"
      # Define el servicio (puerto interno del contenedor adminer es el 8080)
      - "traefik.http.services.adminer.loadbalancer.server.port=8080"

  # phpMyAdmin (Alternativa a Adminer)
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadmin
    restart: always
    environment:
      PMA_HOST: mariadb
      PMA_PORT: 3306
    networks:
      - default
      - proxy # Debe estar en la red de Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Define el router web (puerto 80)
      #- "traefik.http.routers.phpmyadmin-http.rule=Host(`phpmyadmin.local`)"
      #- "traefik.http.routers.phpmyadmin-http.entrypoints=web" # Escucha en HTTP (80)
      #- "traefik.http.routers.phpmyadmin-http.middlewares=redirect-to-https@file" # Redirecciona a HTTPS
      # Define el router websecure (puerto 443)
      - "traefik.http.routers.phpmyadmin.rule=Host(`phpmyadmin.local`)"
      - "traefik.http.routers.phpmyadmin.entrypoints=websecure" # Escucha en HTTPS (443)
      # Habilita TLS usando el resolvedor de certificados stagingacme
      - "traefik.http.routers.phpmyadmin.tls=true"
      - "traefik.http.routers.phpmyadmin.tls.certresolver=stagingacme"
      # Define el servicio (puerto interno del contenedor phpMyAdmin es el 80)
      - "traefik.http.services.phpmyadmin.loadbalancer.server.port=80"

  # SFTPGo (Servidor SFTP con Interfaz Web de Gesti贸n)
  sftpgo:
    image: drakkan/sftpgo:latest
    container_name: sftpgo
    restart: always
    environment:
      # *** Importante: Cambia esta contrase帽a inicial por una segura ***
      SFTPGO_COMMON__INITIAL_ADMIN_USERNAME: sftpgo_admin
      SFTPGO_COMMON__INITIAL_ADMIN_PASSWORD: Contrase帽aMuySegura_SFTPGo123
      # Configuraci贸n de los puertos de SFTP y WebDav/Web UI
      SFTPGO_SFTPD__BINDINGS__0__PORT: 2022
      SFTPGO_WEBDAVD__BINDINGS__0__PORT: 8081
    volumes:
      # Persistencia de la configuraci贸n, usuarios, claves SSH, logs, etc.
      - ./sftpgo/data:/etc/sftpgo
      # *** Acceso a los archivos de los sitios. ***
      - ./sites:/srv/sftpgo/data/var/www/html
    networks:
      - proxy # Para el acceso a la Interfaz Web a trav茅s de Traefik
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # ROUTER HTTPS para la Interfaz Web de Gesti贸n
      - "traefik.http.routers.sftpgo.rule=Host(`sftpgo.local`)"
      - "traefik.http.routers.sftpgo.entrypoints=websecure"
      - "traefik.http.routers.sftpgo.tls=true"
      - "traefik.http.routers.sftpgo.tls.certresolver=stagingacme"
      # Servicio (el puerto interno de la UI de SFTPGo es 8080)
      - "traefik.http.services.sftpgo.loadbalancer.server.port=8080"
    # Puerto SFTP (opcional si no se usa Traefik para SFTP, pero es 煤til exponerlo directamente)
    ports:
      - "2222:2022" # Mapea el puerto 2022 del contenedor al 2222 del host

  # Netdata - Monitorizaci贸n en tiempo real
  netdata:
    image: netdata/netdata
    container_name: netdata
    hostname: ${HOSTNAME} # Opcional: Nombre del host para identificarlo en el dashboard
    restart: always
    # Permisos necesarios para acceder a las m茅tricas del sistema anfitri贸n (host)
    cap_add:
      - SYS_PTRACE
    security_opt:
      - apparmor:unconfined
    volumes:
      # Acceso al socket de Docker para monitorizar todos los contenedores  隆CRUCIAL!
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Montajes para m茅tricas del sistema anfitri贸n
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/etc/os-release:ro
      - /etc/passwd:/etc/passwd:ro
      - /etc/group:/etc/group:ro
    environment:
      - TZ=Europe/Madrid # Configura tu zona horaria
    networks:
      - proxy # Debe estar en la red de Traefik para ser accesible
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # ROUTER HTTPS para el dashboard de Netdata
      - "traefik.http.routers.netdata.rule=Host(`monitor.local`)"
      - "traefik.http.routers.netdata.entrypoints=websecure"
      - "traefik.http.routers.netdata.tls=true"
      - "traefik.http.routers.netdata.tls.certresolver=stagingacme"
      # Servicio (el puerto interno de Netdata es el 19999)
      - "traefik.http.services.netdata.loadbalancer.server.port=19999"
      # Opcional pero Recomendado: Proteger con autenticaci贸n b谩sica (descomentar y usar tu hash)
      - 'traefik.http.middlewares.netdata-auth.basicauth.users=admin:$$apr1$$vCb7HNZD$$80i03SC/tOMXI8uoKMQ.H.'
      - "traefik.http.routers.netdata.middlewares=netdata-auth"

networks:
  proxy:
    external: true
  default:
    # Red interna para Apache, PHP y MariaDB
    internal: false